#jinja2:lstrip_blocks:True,trim_blocks:True
---
- name: Create AEM Network Stack
  cloudformation:
    stack_name: "{{ stack_prefix }}-{{ network.stack_name }}"
    state: present
    region: "{{ aws.region }}"
    disable_rollback: true
    template: "../../../cloudformation/network/network.yaml"
    template_parameters:
      StackPrefix: "{{ stack_prefix}}"
      Ec2InternetGatewayTagNameParameter: "{{ stack_prefix }}-{{ network.internet_gateway.tag_name }}"
      {% for az in aws.availability_zone_list %}
      {% set subname = 'subnet_' + az[-1] %}
      AvailabilityZone{{ az[-1] | upper }}Parameter: "{{ az }}"
      PublishDispatcherELBSubnet{{ az[-1] | upper }}CidrBlockParameter: "{{ network.publish_dispatcher_elb[subname].cidr_block }}"
      PublishDispatcherELBSubnet{{ az[-1] | upper }}TagNameParameter: "{{ stack_prefix }}-{{ network.publish_dispatcher_elb[subname].tag_name }}"
      PublishDispatcherSubnet{{ az[-1] | upper }}CidrBlockParameter: "{{ network.publish_dispatcher[subname].cidr_block }}"
      PublishDispatcherSubnet{{ az[-1] | upper }}TagNameParameter: "{{ stack_prefix }}-{{ network.publish_dispatcher[subname].tag_name }}"
      PublishSubnet{{ az[-1] | upper }}CidrBlockParameter: "{{ network.publish[subname].cidr_block }}"
      PublishSubnet{{ az[-1] | upper }}TagNameParameter: "{{ stack_prefix }}-{{ network.publish[subname].tag_name }}"
      AuthorSubnet{{ az[-1] | upper }}CidrBlockParameter: "{{ network.author[subname].cidr_block }}"
      AuthorSubnet{{ az[-1] | upper }}TagNameParameter: "{{ stack_prefix }}-{{ network.author[subname].tag_name }}"
      AuthorDispatcherSubnet{{ az[-1] | upper }}CidrBlockParameter: "{{ network.author_dispatcher[subname].cidr_block }}"
      AuthorDispatcherSubnet{{ az[-1] | upper }}TagNameParameter: "{{ stack_prefix }}-{{ network.author_dispatcher[subname].tag_name }}"
      ToolSubnet{{ az[-1] | upper }}CidrBlockParameter: "{{ network.tool[subname].cidr_block }}"
      ToolSubnet{{ az[-1] | upper }}TagNameParameter: "{{ stack_prefix }}-{{ network.tool[subname].tag_name }}"
      {% endfor %}
      PublicRouteTableTagNameParameter: "{{ stack_prefix }}-{{ network.public_route_table.tag_name }}"
      PrivateRouteTableTagNameParameter: "{{ stack_prefix }}-{{ network.private_route_table.tag_name }}"
      S3BucketParameter: "{{ endpoints.s3 | default('') }}"
  tags:
  - create
